ARG debian_tag
FROM debian:${debian_tag}

MAINTAINER Quaternion Risk Management
LABEL Description="Provide a base environment for building in C++ with Boost"

RUN apt-get update && apt-get upgrade -y \
 && apt-get install -f -y build-essential wget libbz2-dev autoconf libtool dos2unix cmake zlib1g-dev opencl-headers ocl-icd-opencl-dev \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

ARG boost_version
ARG boost_dir
ARG boost_variant=release
ARG num_cores

RUN wget http://downloads.sourceforge.net/project/boost/boost/${boost_version}/${boost_dir}.tar.gz \
    && tar xfz ${boost_dir}.tar.gz \
    && rm ${boost_dir}.tar.gz \
    && cd ${boost_dir} \
    && ./bootstrap.sh \
    && ./b2 --without-python -j ${num_cores} link=shared runtime-link=shared variant=${boost_variant} install \
    && cd .. \
    && rm -rf ${boost_dir} \
    && ldconfig
	
# syntax = nexus3.acadiasoft.net:4445/docker/dockerfile:experimental
ARG quantlib_version=${QL_TAG}
ARG cmake_build_type=${CMAKE_BUILD_TYPE}
FROM env_quantlib:${quantlib_version}

MAINTAINER Quaternion Risk Management
LABEL Description="Build ORE and add to the QuantLib build environment"

# Argument for number of cores to use while building
ARG num_cores

# install Eigen
RUN apt-get update \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y doxygen graphviz ccache libeigen3-dev \
  && apt-get clean

ENV PATH="/usr/lib/ccache:$PATH"
ENV CCACHE_DIR="/ccache"
ENV CCACHE_MAXSIZE="10G"
# needed if QL_USE_PCH is ON
#ENV CCACHE_SLOPPINESS="pch_defines,time_macros,pch_defines,time_macros,include_file_mtime,include_file_ctim"

# Copy ORE sources for libs and app
COPY QuantLib /ore/QuantLib
COPY QuantExt /ore/QuantExt
COPY OREData /ore/OREData
COPY OREAnalytics /ore/OREAnalytics
COPY App /ore/App
COPY ThirdPartyLibs /ore/ThirdPartyLibs
COPY ORETest /ore/ORETest
COPY cmake /ore/cmake
COPY Docker /ore/Docker

# Need the dos2unix all if building from Windows because the shell 
# scripts fail if there are CRLF present in the files
RUN cd /ore \
  && find -regex ".*\.\(sh\|in\|ac\|am\)" -exec dos2unix {} ';' \
  && mkdir -p build.ore && cd build.ore \
  && cmake .. -DQL_USE_PCH=OFF -DORE_BUILD_DOC=ON -DCMAKE_BUILD_TYPE=${cmake_build_type} -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_EXTENSIONS=OFF  -DCMAKE_CXX_FLAGS="-D BOOST_ENABLE_ASSERT_HANDLER -mavx2" -DQL_ENABLE_SESSIONS=ON -DQL_ENABLE_PARALLEL_UNIT_TEST_RUNNER=ON -DQL_BUILD_EXAMPLES=OFF -DQL_BUILD_BENCHMARK=OFF -DORE_ENABLE_PARALLEL_UNIT_TEST_RUNNER=ON -DORE_USE_ZLIB=ON -D ORE_ENABLE_OPENCL=ON

WORKDIR /ore/build.ore
RUN --mount=type=cache,target=/ccache/ ccache -z \
  && make -j ${num_cores} \
  && ccache -s \
  && make install \
  && make doc_quantext 2>&1 | grep -v "ignoring unsupported tag" \
  && make doc_ored 2>&1 | grep -v "ignoring unsupported tag" \
  && make doc_orea 2>&1 | grep -v "ignoring unsupported tag" 
  
WORKDIR / 
RUN mkdir -p html \
  && mkdir /html/ored && cp -r /ore/OREData/doc/html/* /html/ored \
  && mkdir /html/orea && cp -r /ore/OREAnalytics/doc/html/* /html/orea \
  && mkdir /html/qle && cp -r /ore/QuantExt/doc/html/* /html/qle \
  && rm -rf ore

CMD bash
